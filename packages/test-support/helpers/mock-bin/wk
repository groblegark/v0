#!/usr/bin/env bash
# Mock wk command for testing
# Behavior controlled by environment variables:
#   MOCK_WK_LIST_OUTPUT - output for wk list
#   MOCK_WK_NEW_ID - issue ID to return for wk new (default: mock-abc1)
#   MOCK_WK_NEW_FAIL - set to 1 to make wk new fail

case "$1" in
    "list")
        if [ -n "$MOCK_WK_LIST_OUTPUT" ]; then
            echo "$MOCK_WK_LIST_OUTPUT"
        fi
        exit 0
        ;;
    "init")
        exit 0
        ;;
    "new")
        if [ -n "$MOCK_WK_NEW_FAIL" ]; then
            echo "Error: mock wk new failure" >&2
            exit 1
        fi
        # Extract title from args ($2 is type, $3 is title)
        type="$2"
        title="$3"
        issue_id="${MOCK_WK_NEW_ID:-mock-abc1}"
        # Check for -o id flag
        output_id_only=false
        for arg in "$@"; do
            if [[ "$arg" == "id" ]] && [[ "${prev_arg:-}" == "-o" ]]; then
                output_id_only=true
            fi
            prev_arg="$arg"
        done
        if $output_id_only; then
            echo "${issue_id}"
        else
            echo "Created [${type}] (todo) ${issue_id}: ${title}"
        fi
        exit 0
        ;;
    "edit")
        # Silent success for edit commands
        exit 0
        ;;
    "label")
        # Output to stdout if MOCK_WK_LABEL_OUTPUT is set (for testing redirection)
        if [ -n "$MOCK_WK_LABEL_OUTPUT" ]; then
            echo "$MOCK_WK_LABEL_OUTPUT"
        fi
        exit 0
        ;;
    "show")
        # Support MOCK_DATA_DIR for per-issue mock data
        issue_id="$2"
        if [[ -n "${MOCK_DATA_DIR:-}" ]]; then
            mock_file="${MOCK_DATA_DIR}/wk/${issue_id}.json"
            if [[ -f "${mock_file}" ]]; then
                cat "${mock_file}"
                exit 0
            fi
        fi
        # Default: return basic JSON
        echo '{"status": "open"}'
        exit 0
        ;;
    *)
        exit 0
        ;;
esac
