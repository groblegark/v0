#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
# v0 - A tool to ease you in to multi-agent vibe coding
# Usage: v0 <command> [args]

set -e

# Resolve symlinks to find real install location
SOURCE="${0}"
while [[ -L "${SOURCE}" ]]; do
  DIR="$(cd -P "$(dirname "${SOURCE}")" && pwd)"
  SOURCE="$(readlink "${SOURCE}")"
  [[ ${SOURCE} != /* ]] && SOURCE="${DIR}/${SOURCE}"
done
V0_DIR="$(cd -P "$(dirname "${SOURCE}")/.." && pwd)"

# Commands that need config
CONFIG_COMMANDS="plan tree decompose merge mergeq status feature resume fix chore attach cancel shutdown startup hold"

# Commands that work without config
NO_CONFIG_COMMANDS="init help version coffee"

show_help() {
  cat <<'EOF'
v0 - A tool to ease you in to multi-agent vibe coding.

Usage: v0 <command> [args]

Commands:
  init          Initialize .v0.rc in current directory
  status        Show operation status
  watch         Continuously watch status (like 'status --watch')
  startup       Start workers (fix, chore, mergeq)
  shutdown      Stop all v0 processes for this project

  fix           Sequential bug fixing worker
  chore         Sequential chore processing worker
  feat[ure]     Full pipeline: plan -> decompose -> execute -> merge
  plan          Create implementation plan from prompt
  decomp[ose]   Convert plan to issues
  merge         Merge worktree branch to main
  mergeq        Merge queue daemon

  attach        Attach to a running tmux session (fix, chore, mergeq, feature)
  cancel        Cancel a running operation
  resume        Resume an existing feature (alias for 'feature --resume')
  hold          Put an operation on hold (pause phase transitions)
  prune         Remove completed/cancelled operation state
  monitor       Monitor worker queues for auto-shutdown

  talk          Open claude with haiku model for quick conversations
  coffee        Keep computer awake
  issue         Alias for 'wk' issue tracker (see 'wk --help')

  self          Debug and diagnostics commands

Options:
  --help, -h    Show this help
  --version     Show version

Examples:
  v0 init                              # Create .v0.rc in current project
  v0 feature auth "Add JWT auth"       # Full autonomous pipeline
  v0 fix "Button not working"          # Report a bug to the fix worker
  v0 status                            # List all operations
  v0 plan api "Build REST API"         # Just create a plan

Tmux sessions:
  Workers run in tmux sessions. Use 'v0 attach <type>' to connect.
  Ctrl-B D to detach, Ctrl-B [ to scroll (q to exit scroll mode).

Configuration:
  Each project needs a .v0.rc file at its root. Run 'v0 init' to create one.

For more information, see: https://github.com/alfredjeanlab/v0
EOF
}

show_version() {
  echo "v0 0.1.0"
}

# Sanitize a string for display (truncate and escape control chars)
sanitize_for_display() {
  local str="$1"
  local max_len="${2:-60}"

  # Replace newlines and tabs with spaces, collapse whitespace
  str=$(printf '%s' "${str}" | tr '\n\t\r' '   ' | tr -s ' ')

  # Truncate if too long
  if [[ ${#str} -gt ${max_len} ]]; then
    str="${str:0:${max_len}}..."
  fi

  echo "${str}"
}

# Handle special commands first
case "${1:-}" in
  init)
    source "${V0_DIR}/lib/v0-common.sh"

    # Check dependencies first
    if ! v0_precheck; then
      echo "" >&2
      echo "Please install missing dependencies and try again." >&2
      exit 1
    fi

    shift
    v0_init_config "${1:-.}"
    exit 0
    ;;
  help|--help|-h)
    show_help
    exit 0
    ;;
  version|--version)
    show_version
    exit 0
    ;;
  "")
    show_help
    exit 0
    ;;
esac

# Dispatch to subcommand
CMD="${1}"
shift

case "${CMD}" in
  plan|tree|decompose|merge|mergeq|status|watch|feature|fix|chore|attach|cancel|shutdown|startup|talk|coffee|prune|monitor|hold)
    exec "${V0_DIR}/bin/v0-${CMD}" "$@"
    ;;
  self-debug)
    exec "${V0_DIR}/bin/v0-self-debug" "$@"
    ;;
  self)
    # Handle 'v0 self <subcommand>' dispatch
    case "${1:-}" in
      debug)
        shift
        exec "${V0_DIR}/bin/v0-self-debug" "$@"
        ;;
      --help|-h|"")
        cat <<'SELF_HELP'
v0 self - Debug and diagnostics commands

Usage: v0 self <command> [args]

Commands:
  debug         Generate debug report for failed operations

Run 'v0 self debug --help' for debug command options.

Examples:
  v0 self debug my-feature     # Debug a specific feature operation
  v0 self debug fix            # Debug fix worker issues
  v0 self debug mergeq         # Debug merge queue daemon
SELF_HELP
        exit 0
        ;;
      *)
        echo "Unknown self command: ${1}" >&2
        echo "Run 'v0 self --help' for usage" >&2
        exit 1
        ;;
    esac
    ;;
  # Aliases
  feat)
    exec "${V0_DIR}/bin/v0-feature" "$@"
    ;;
  resume)
    exec "${V0_DIR}/bin/v0-feature" --resume "$@"
    ;;
  decomp)
    exec "${V0_DIR}/bin/v0-decompose" "$@"
    ;;
  bug|bugfix)
    exec "${V0_DIR}/bin/v0-fix" "$@"
    ;;
  chat)
    exec "${V0_DIR}/bin/v0-talk" "$@"
    ;;
  issue)
    exec wk "$@"
    ;;
  show)
    # Undocumented alias: v0 show [<feature-name>|chore|fix|merge(q)?]
    case "${1:-}" in
      chore) shift; exec "${V0_DIR}/bin/v0-status" --chore "$@" ;;
      fix) shift; exec "${V0_DIR}/bin/v0-status" --fix "$@" ;;
      merge|mergeq) shift; exec "${V0_DIR}/bin/v0-status" --merge "$@" ;;
      *) exec "${V0_DIR}/bin/v0-status" "$@" ;;
    esac
    ;;
  *)
    # Sanitize command for display
    safe_cmd=$(sanitize_for_display "${CMD}")

    echo "Unknown command: ${safe_cmd}" >&2
    echo "" >&2

    # If it looks like a description (contains spaces/long), suggest v0 fix
    if [[ ${#CMD} -gt 20 ]] || [[ "${CMD}" == *" "* ]] || [[ "${CMD}" == *$'\n'* ]]; then
      echo "Did you mean to report a bug? Try:" >&2
      echo "  v0 fix \"${safe_cmd}\"" >&2
      echo "" >&2
    fi

    echo "Run 'v0 --help' for usage" >&2
    exit 1
    ;;
esac
