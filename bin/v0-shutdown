#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
# v0-shutdown - Stop all v0 processes for the current project
set -e

V0_DIR="$(cd "$(dirname "$0")/.." && pwd)"
source "${V0_DIR}/packages/cli/lib/v0-common.sh"
v0_load_config

# Source coffee functions for automatic wake lock management
source "${V0_DIR}/packages/worker/lib/coffee-common.sh"

# Source nudge functions for idle session monitoring
source "${V0_DIR}/packages/worker/lib/nudge-common.sh"

# Source worker functions for issue cleanup
source "${V0_DIR}/packages/worker/lib/worker-common.sh"

usage() {
  v0_help <<'EOF'
Usage: v0 stop [options]

Stop all v0 workers, daemons, and sessions for the current project.

This is a complete shutdown that:
- Terminates all tmux sessions for this project
- Kills polling daemons
- Removes worker worktrees (v0-*-worker)
- Deletes worker branches (*-bugs, *-chores, v0/worker/*)
- Deletes legacy v0-*-worker branches (old naming convention)

Note: Worker branches (bugs/chores) are checked before deletion.
If they contain commits not in ${V0_DEVELOP_BRANCH:-main}, a warning is shown
and the branch is preserved. Use --force to delete them anyway.

Options:
  --force             Force kill and delete branches with unmerged commits
  --drop-workspace    Also remove workspace and all worktrees (workspace can be recreated)
  --drop-everything   Full reset: remove workspace, build state, and agent remote
  --dry-run           Show what would be stopped without stopping
  -h, --help          Show this help

The --drop-* options remove persistent state:
  --drop-workspace    Removes: ~/.local/state/v0/${PROJECT}/workspace/
                              ~/.local/state/v0/${PROJECT}/tree/
  --drop-everything   Removes: ~/.local/state/v0/${PROJECT}/ (entire state dir)
                              ${V0_ROOT}/.v0/ (build state, last-push marker)
                              'agent' git remote

Examples:
  v0 stop                    # Stop all v0 processes and clean up
  v0 stop --dry-run          # Preview what would be stopped
  v0 stop --force            # Force kill and delete all branches
  v0 stop --drop-workspace   # Stop and remove workspace (can be recreated)
  v0 stop --drop-everything  # Full reset (removes all v0 state for project)
EOF
  exit 0
}

FORCE=""
DRY_RUN=""
DROP_WORKSPACE=""
DROP_EVERYTHING=""

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --force)
      FORCE=1
      shift
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    --drop-workspace)
      DROP_WORKSPACE=1
      shift
      ;;
    --drop-everything)
      DROP_EVERYTHING=1
      shift
      ;;
    -h|--help)
      usage
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Run 'v0 stop --help' for usage" >&2
      exit 1
      ;;
  esac
done

# Show which project we're working on
echo "Shutting down v0 for project: ${PROJECT}"
echo ""

# Find all tmux sessions for this project
# Pattern: v0-{project}-*
SESSION_PREFIX="v0-${PROJECT}-"

# Get all matching sessions
all_sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | v0_grep "^${SESSION_PREFIX}" || true)

# Track if we found anything to clean up
found_anything=""

if [[ -n "${all_sessions}" ]]; then
  found_anything=1
  session_count=$(echo "${all_sessions}" | wc -l | tr -d ' ')
  echo "Found ${session_count} v0 session(s) for project: ${PROJECT}"
  echo ""

  # List sessions
  while IFS= read -r session; do
    [[ -z "${session}" ]] && continue

    if [[ -n "${DRY_RUN}" ]]; then
      echo "Would stop: ${session}"
    else
      echo "Stopping: ${session}"
      if [[ -n "${FORCE}" ]]; then
        tmux kill-session -t "${session}" 2>/dev/null || true
      else
        # Send SIGTERM to allow graceful shutdown
        tmux send-keys -t "${session}" C-c 2>/dev/null || true
        sleep 0.5
        tmux kill-session -t "${session}" 2>/dev/null || true
      fi
    fi
  done <<< "${all_sessions}"
fi

# Also kill polling daemons
polling_pids=$(pgrep -f "while true.*v0-${PROJECT}" 2>/dev/null || true)
if [[ -n "${polling_pids}" ]]; then
  found_anything=1
  if [[ -n "${DRY_RUN}" ]]; then
    echo ""
    echo "Would kill polling daemons: ${polling_pids}"
  else
    echo ""
    echo "Stopping polling daemons..."
    pkill -f "while true.*v0-${PROJECT}" 2>/dev/null || true
  fi
fi

# Stop mergeq daemon if running
mergeq_pid_file="${BUILD_DIR}/mergeq/.daemon.pid"
if [[ -f "${mergeq_pid_file}" ]]; then
  found_anything=1
  if [[ -n "${DRY_RUN}" ]]; then
    echo ""
    echo "Would stop mergeq daemon"
  else
    echo ""
    echo "Stopping mergeq daemon..."
    "${V0_DIR}/bin/v0-mergeq" --stop 2>/dev/null || true
  fi
fi

# Reopen in-progress issues owned by workers being shut down
echo ""
echo "Checking for in-progress issues to reopen..."

for worker in "worker:fix" "worker:chore"; do
  if [[ -n "${DRY_RUN}" ]]; then
    # Show what would be reopened
    issues=$(wk list --status in_progress --assignee "${worker}" -o json 2>/dev/null | jq -r '.[].id' || true)
    while IFS= read -r issue_id; do
      [[ -z "${issue_id}" ]] && continue
      echo "Would reopen: ${issue_id} (was assigned to ${worker})"
    done <<< "${issues}"
  else
    reopen_worker_issues "${worker}"
  fi
done

# Clean up worker worktrees
# Storage locations:
# 1. XDG state directory: ~/.local/state/v0/{project}/tree/v0-*-worker/
# 2. Git directory fallback: .git/v0-worktrees/v0-*-worker/
XDG_TREE_ROOT="${V0_STATE_DIR}/tree"
GIT_TREE_ROOT="$(git -C "${V0_ROOT}" rev-parse --git-common-dir 2>/dev/null || echo "${V0_ROOT}/.git")/v0-worktrees"

# Normalize git root path (may be relative)
if [[ "${GIT_TREE_ROOT}" != /* ]]; then
  GIT_TREE_ROOT="${V0_ROOT}/${GIT_TREE_ROOT}"
fi

# Find all worker worktrees in XDG location
xdg_worktrees=""
if [[ -d "${XDG_TREE_ROOT}" ]]; then
  for dir in "${XDG_TREE_ROOT}"/v0-*-worker; do
    if [[ -d "${dir}" ]]; then
      xdg_worktrees="${xdg_worktrees}${dir}"$'\n'
    fi
  done
  xdg_worktrees="${xdg_worktrees%$'\n'}"  # Remove trailing newline
fi

# Find all worker worktrees in git fallback location
git_worktrees=""
if [[ -d "${GIT_TREE_ROOT}" ]]; then
  for dir in "${GIT_TREE_ROOT}"/v0-*-worker; do
    if [[ -d "${dir}" ]]; then
      git_worktrees="${git_worktrees}${dir}"$'\n'
    fi
  done
  git_worktrees="${git_worktrees%$'\n'}"  # Remove trailing newline
fi

# Combine worktrees
all_worktrees="${xdg_worktrees}"
if [[ -n "${git_worktrees}" ]]; then
  if [[ -n "${all_worktrees}" ]]; then
    all_worktrees="${all_worktrees}"$'\n'"${git_worktrees}"
  else
    all_worktrees="${git_worktrees}"
  fi
fi

if [[ -n "${all_worktrees}" ]]; then
  found_anything=1
  echo ""
  echo "Cleaning up worker worktrees..."
  while IFS= read -r tree_dir; do
    [[ -z "${tree_dir}" ]] && continue
    [[ ! -d "${tree_dir}" ]] && continue

    # Find the actual worktree (repo subdirectory)
    for subdir in "${tree_dir}"/*; do
      if [[ -d "${subdir}" ]] && { [[ -d "${subdir}/.git" ]] || [[ -f "${subdir}/.git" ]]; }; then
        if [[ -n "${DRY_RUN}" ]]; then
          echo "Would remove worktree: ${subdir}"
        else
          echo "Removing worktree: ${subdir}"
          git -C "${V0_ROOT}" worktree remove --force "${subdir}" 2>/dev/null || rm -rf "${subdir}" 2>/dev/null || true
        fi
      fi
    done

    # Remove the tree directory itself
    if [[ -n "${DRY_RUN}" ]]; then
      echo "Would remove tree dir: ${tree_dir}"
    else
      rm -rf "${tree_dir}" 2>/dev/null || true
    fi
  done <<< "${all_worktrees}"
fi

# Clean up worker branches (local and remote)
# Patterns: v0/worker/* (legacy), *-bugs, *-chores (user-specific)
local_branches=$(git -C "${V0_ROOT}" branch --list 'v0/worker/*' '*-bugs' '*-chores' 2>/dev/null | sed 's/^[+* ]*//' || true)
remote_branches=$(git -C "${V0_ROOT}" branch -r --list "${V0_GIT_REMOTE}/v0/worker/*" "${V0_GIT_REMOTE}/*-bugs" "${V0_GIT_REMOTE}/*-chores" 2>/dev/null | sed 's/^[+* ]*//' || true)

# Track branches skipped due to unmerged commits
skipped_branches=""

if [[ -n "${local_branches}" ]]; then
  found_anything=1
  echo ""
  echo "Cleaning up local worker branches..."
  while IFS= read -r branch; do
    [[ -z "${branch}" ]] && continue

    # Check if this is a worker branch that needs merge verification
    # Patterns: v0/worker/chore, v0/worker/fix (legacy), *-bugs, *-chores (user-specific)
    if [[ "${branch}" == "v0/worker/chore" || "${branch}" == "v0/worker/fix" || \
          "${branch}" == *-bugs || "${branch}" == *-chores ]]; then
      # Check if branch is merged (is an ancestor of develop branch)
      if ! git -C "${V0_ROOT}" merge-base --is-ancestor "${branch}" "${V0_DEVELOP_BRANCH}" 2>/dev/null; then
        if [[ -z "${FORCE}" ]]; then
          echo "Warning: ${branch} has commits not in ${V0_DEVELOP_BRANCH}, skipping (use --force to delete)"
          skipped_branches="${skipped_branches}${branch}"$'\n'
          continue
        else
          echo "Warning: ${branch} has commits not in ${V0_DEVELOP_BRANCH}, deleting anyway (--force)"
        fi
      fi
    fi

    if [[ -n "${DRY_RUN}" ]]; then
      echo "Would delete local branch: ${branch}"
    else
      echo "Deleting local branch: ${branch}"
      git -C "${V0_ROOT}" branch -D "${branch}" 2>/dev/null || true
    fi
  done <<< "${local_branches}"
fi

if [[ -n "${remote_branches}" ]]; then
  found_anything=1
  echo ""
  echo "Cleaning up remote worker branches..."
  while IFS= read -r branch; do
    [[ -z "${branch}" ]] && continue
    # Remove remote prefix to get the branch name for deletion
    branch_name="${branch#"${V0_GIT_REMOTE}"/}"

    # Check if this is a worker branch that needs merge verification
    # Patterns: v0/worker/chore, v0/worker/fix (legacy), *-bugs, *-chores (user-specific)
    if [[ "${branch_name}" == "v0/worker/chore" || "${branch_name}" == "v0/worker/fix" || \
          "${branch_name}" == *-bugs || "${branch_name}" == *-chores ]]; then
      # Check if the remote branch is merged (fetch first to ensure we have the ref)
      if ! git -C "${V0_ROOT}" merge-base --is-ancestor "${branch}" "${V0_DEVELOP_BRANCH}" 2>/dev/null; then
        if [[ -z "${FORCE}" ]]; then
          echo "Warning: ${branch_name} (remote) has commits not in ${V0_DEVELOP_BRANCH}, skipping (use --force to delete)"
          skipped_branches="${skipped_branches}${branch_name} (remote)"$'\n'
          continue
        else
          echo "Warning: ${branch_name} (remote) has commits not in ${V0_DEVELOP_BRANCH}, deleting anyway (--force)"
        fi
      fi
    fi

    if [[ -n "${DRY_RUN}" ]]; then
      echo "Would delete remote branch: ${branch_name}"
    else
      echo "Deleting remote branch: ${branch_name}"
      git -C "${V0_ROOT}" push "${V0_GIT_REMOTE}" --delete "${branch_name}" 2>/dev/null || true
    fi
  done <<< "${remote_branches}"
fi

# Clean up old-style v0-*-worker branches (legacy naming convention)
old_style_branches=$(git -C "${V0_ROOT}" branch --list 'v0-*-worker' 2>/dev/null | sed 's/^[+* ]*//' || true)
if [[ -n "${old_style_branches}" ]]; then
  found_anything=1
  echo ""
  echo "Cleaning up old-style v0-*-worker branches..."
  while IFS= read -r branch; do
    [[ -z "${branch}" ]] && continue

    if [[ -n "${DRY_RUN}" ]]; then
      echo "Would delete local branch: ${branch}"
    else
      echo "Deleting local branch: ${branch}"
      git -C "${V0_ROOT}" branch -D "${branch}" 2>/dev/null || true
    fi
  done <<< "${old_style_branches}"
fi

# Clean up v0/agent/* branches (user-specific develop branches)
# Only delete when --drop-workspace or --drop-everything AND using worktree mode
# In clone mode, the develop branch is main/develop/master which should not be deleted
if [[ ( -n "${DROP_WORKSPACE}" || -n "${DROP_EVERYTHING}" ) && "${V0_WORKSPACE_MODE}" == "worktree" ]]; then
  # Find v0/agent/* branches (excluding worker branches already handled above)
  agent_branches=$(git -C "${V0_ROOT}" branch --list 'v0/agent/*' 2>/dev/null | sed 's/^[+* ]*//' | v0_grep -v '\-bugs$\|\-chores$' || true)
  agent_remote_branches=$(git -C "${V0_ROOT}" branch -r --list "${V0_GIT_REMOTE}/v0/agent/*" 2>/dev/null | sed 's/^[+* ]*//' | v0_grep -v '\-bugs$\|\-chores$' || true)

  if [[ -n "${agent_branches}" ]]; then
    found_anything=1
    echo ""
    echo "Cleaning up agent develop branches (worktree mode)..."
    while IFS= read -r branch; do
      [[ -z "${branch}" ]] && continue

      if [[ -n "${DRY_RUN}" ]]; then
        echo "Would delete local branch: ${branch}"
      else
        echo "Deleting local branch: ${branch}"
        git -C "${V0_ROOT}" branch -D "${branch}" 2>/dev/null || true
      fi
    done <<< "${agent_branches}"
  fi

  if [[ -n "${agent_remote_branches}" ]]; then
    found_anything=1
    echo ""
    echo "Cleaning up remote agent develop branches (worktree mode)..."
    while IFS= read -r branch; do
      [[ -z "${branch}" ]] && continue
      branch_name="${branch#"${V0_GIT_REMOTE}"/}"

      if [[ -n "${DRY_RUN}" ]]; then
        echo "Would delete remote branch: ${branch_name}"
      else
        echo "Deleting remote branch: ${branch_name}"
        git -C "${V0_ROOT}" push "${V0_GIT_REMOTE}" --delete "${branch_name}" 2>/dev/null || true
      fi
    done <<< "${agent_remote_branches}"
  fi
fi

# Check if coffee is running (so we don't exit early if only coffee needs stopping)
if coffee_is_running; then
  found_anything=1
  if [[ -n "${DRY_RUN}" ]]; then
    echo ""
    echo "Would stop coffee (system wake lock)"
  fi
fi

# Check if prune daemon is running
if prune_daemon_running; then
  found_anything=1
  if [[ -n "${DRY_RUN}" ]]; then
    echo ""
    echo "Would stop prune daemon (pid: $(prune_daemon_pid))"
  fi
fi

# Check if nudge daemon is running
if nudge_running; then
  found_anything=1
  if [[ -n "${DRY_RUN}" ]]; then
    echo ""
    echo "Would stop nudge daemon (pid: $(nudge_pid))"
  fi
fi

if [[ -z "${found_anything}" ]]; then
  echo "No v0 sessions running for project: ${PROJECT}"
  exit 0
fi

if [[ -z "${DRY_RUN}" ]]; then
  # Stop nudge worker
  if nudge_running; then
    "${V0_DIR}/bin/v0-nudge" stop >/dev/null 2>&1
    echo ""
    echo "Stopped nudge worker"
  fi

  # Stop coffee (system wake lock)
  if coffee_is_running; then
    coffee_stop
    echo ""
    echo "Stopped coffee (system can sleep)"
  fi

  # Wait for background pruning to complete if running
  if prune_daemon_running; then
    echo ""
    echo "Waiting for background pruning to complete..."
    prune_daemon_wait
    echo "Background pruning stopped"
  fi

  # Final synchronous prune to catch anything new
  echo ""
  echo "Pruning old mergeq entries..."
  v0_prune_mergeq

  echo ""
  echo "Pruning old log entries..."
  v0_prune_logs

  # Handle --drop-workspace: remove workspace and all worktrees
  if [[ -n "${DROP_WORKSPACE}" || -n "${DROP_EVERYTHING}" ]]; then
    echo ""
    echo "Removing workspace and worktrees..."

    # Remove merge workspace
    if [[ -d "${V0_WORKSPACE_DIR}" ]]; then
      # If it's a worktree, remove it properly first
      if [[ -f "${V0_WORKSPACE_DIR}/.git" ]]; then
        git -C "${V0_ROOT}" worktree remove --force "${V0_WORKSPACE_DIR}" 2>/dev/null || true
      fi
      rm -rf "${V0_WORKSPACE_DIR}" 2>/dev/null || true
      echo "Removed workspace: ${V0_WORKSPACE_DIR}"
    fi

    # Remove all feature worktrees
    if [[ -d "${V0_STATE_DIR}/tree" ]]; then
      for tree_dir in "${V0_STATE_DIR}/tree"/*; do
        [[ -d "${tree_dir}" ]] || continue
        # Find and remove worktrees in this tree dir
        for subdir in "${tree_dir}"/*; do
          if [[ -d "${subdir}" ]] && { [[ -d "${subdir}/.git" ]] || [[ -f "${subdir}/.git" ]]; }; then
            git -C "${V0_ROOT}" worktree remove --force "${subdir}" 2>/dev/null || rm -rf "${subdir}" 2>/dev/null || true
          fi
        done
        rm -rf "${tree_dir}" 2>/dev/null || true
      done
      rm -rf "${V0_STATE_DIR}/tree" 2>/dev/null || true
      echo "Removed worktrees: ${V0_STATE_DIR}/tree"
    fi

    # Clean up workspace parent directory if empty
    if [[ -d "${V0_STATE_DIR}/workspace" ]]; then
      rmdir "${V0_STATE_DIR}/workspace" 2>/dev/null || true
    fi

    # Remove project registration (unregister from v0 watch --all)
    root_file="${V0_STATE_DIR}/.v0.root"
    if [[ -f "${root_file}" ]]; then
      rm -f "${root_file}"
      echo "Removed project registration"
    fi
  fi

  # Handle --drop-everything: remove all state
  if [[ -n "${DROP_EVERYTHING}" ]]; then
    echo ""
    echo "Removing all v0 state..."

    # Remove entire .v0 directory (includes build/, last-push, etc.)
    v0_dir="${V0_ROOT}/.v0"
    if [[ -d "${v0_dir}" ]]; then
      rm -rf "${v0_dir}" 2>/dev/null || true
      echo "Removed .v0 directory: ${v0_dir}"
    fi

    # Remove agent remote from git config
    if git -C "${V0_ROOT}" remote get-url agent &>/dev/null 2>&1; then
      git -C "${V0_ROOT}" remote remove agent 2>/dev/null || true
      echo "Removed 'agent' git remote"
    fi

    # Remove entire state directory (includes agent.git bare repo)
    if [[ -d "${V0_STATE_DIR}" ]]; then
      rm -rf "${V0_STATE_DIR}" 2>/dev/null || true
      echo "Removed state directory: ${V0_STATE_DIR}"
    fi
  fi

  echo ""
  if [[ -n "${skipped_branches}" ]]; then
    echo "Shutdown complete (some branches preserved)"
    echo ""
    echo "The following branches have unmerged commits and were not deleted:"
    while IFS= read -r skipped; do
      [[ -z "${skipped}" ]] && continue
      echo "  - ${skipped}"
    done <<< "${skipped_branches}"
    echo ""
    echo "Use 'v0 stop --force' to delete them anyway."
  elif [[ -n "${DROP_EVERYTHING}" ]]; then
    echo "Shutdown complete (all state removed)"
    echo ""
    echo "To reinitialize v0 for this project, run: v0 init"
  elif [[ -n "${DROP_WORKSPACE}" ]]; then
    echo "Shutdown complete (workspace removed)"
    echo ""
    echo "Workspace will be recreated on next merge operation."
  else
    echo "Shutdown complete"
  fi
else
  # Dry-run mode: show what would be done
  if prune_daemon_running; then
    echo ""
    echo "Would stop prune daemon"
  fi

  echo ""
  echo "Pruning old mergeq entries..."
  v0_prune_mergeq --dry-run

  echo ""
  echo "Pruning old log entries..."
  v0_prune_logs --dry-run

  # Show what --drop-workspace would do
  if [[ -n "${DROP_WORKSPACE}" || -n "${DROP_EVERYTHING}" ]]; then
    echo ""
    echo "Would remove workspace and worktrees:"
    if [[ -d "${V0_WORKSPACE_DIR}" ]]; then
      echo "  Would remove workspace: ${V0_WORKSPACE_DIR}"
    fi
    if [[ -d "${V0_STATE_DIR}/tree" ]]; then
      echo "  Would remove worktrees: ${V0_STATE_DIR}/tree"
    fi
    root_file="${V0_STATE_DIR}/.v0.root"
    if [[ -f "${root_file}" ]]; then
      echo "  Would remove project registration: ${root_file}"
    fi
  fi

  # Show what --drop-everything would do
  if [[ -n "${DROP_EVERYTHING}" ]]; then
    echo ""
    echo "Would remove all v0 state:"
    v0_dir="${V0_ROOT}/.v0"
    if [[ -d "${v0_dir}" ]]; then
      echo "  Would remove .v0 directory: ${v0_dir}"
    fi
    if git -C "${V0_ROOT}" remote get-url agent &>/dev/null 2>&1; then
      echo "  Would remove 'agent' git remote"
    fi
    if [[ -d "${V0_STATE_DIR}" ]]; then
      echo "  Would remove state directory: ${V0_STATE_DIR}"
    fi
  fi
fi
