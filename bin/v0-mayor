#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
# v0-mayor - Launch Claude as orchestration assistant
# Usage: v0 mayor [args]

set -e

V0_DIR="$(cd "$(dirname "$0")/.." && pwd)"
source "${V0_DIR}/packages/cli/lib/v0-common.sh"

usage() {
  v0_help <<'EOF'
Usage: v0 mayor [options] [claude-args...]

Launch Claude as an orchestration assistant for managing v0 workers.

The mayor runs interactively (no worktree, no tmux) and is primed with
project context to help you:
  - Plan and dispatch features
  - Queue bug fixes
  - Process chores
  - Monitor worker status
  - Organize and prioritize work

Options:
  --model <model>   Override model (default: opus)
  -h, --help        Show this help

Examples:
  v0 mayor                 # Start mayor session
  v0 mayor --model sonnet  # Use faster model
EOF
  exit 0
}

MODEL="opus"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --model) MODEL="$2"; shift 2 ;;
    -h|--help) usage ;;
    *) break ;;
  esac
done

PROMPT_FILE="${V0_DIR}/packages/cli/lib/prompts/mayor.md"
PROMPT="$(cat "${PROMPT_FILE}")"

# Create temporary settings for mayor session with auto-priming hooks
MAYOR_SETTINGS_DIR="${TMPDIR:-/tmp}/v0-mayor-$$"
mkdir -p "${MAYOR_SETTINGS_DIR}/.claude"

cat > "${MAYOR_SETTINGS_DIR}/.claude/settings.local.json" <<'SETTINGS'
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "",
        "hooks": [
          {"type": "command", "command": "v0 prime"},
          {"type": "command", "command": "wk prime 2>/dev/null || true"}
        ]
      }
    ],
    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {"type": "command", "command": "v0 prime"},
          {"type": "command", "command": "wk prime 2>/dev/null || true"}
        ]
      }
    ]
  }
}
SETTINGS

# Cleanup function for temporary settings
cleanup() {
  rm -rf "${MAYOR_SETTINGS_DIR}"
}
trap cleanup EXIT

# Run claude with the settings directory
exec claude --model "${MODEL}" --settings-dir "${MAYOR_SETTINGS_DIR}" "${PROMPT}" "$@"
