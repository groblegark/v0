#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
# v0-mayor - Launch Claude as orchestration assistant
# Usage: v0 mayor [args]

set -e

V0_DIR="$(cd "$(dirname "$0")/.." && pwd)"
source "${V0_DIR}/packages/cli/lib/v0-common.sh"

usage() {
  v0_help <<'EOF'
Usage: v0 mayor [options] [claude-args...]

Launch Claude as an orchestration assistant for managing v0 workers.

The mayor runs interactively (no worktree, no tmux) and is primed with
project context to help you:
  - Plan and dispatch features
  - Queue bug fixes
  - Process chores
  - Monitor worker status
  - Organize and prioritize work

Options:
  --model <model>   Override model (default: opus)
  -h, --help        Show this help

Examples:
  v0 mayor                 # Start mayor session
  v0 mayor --model sonnet  # Use faster model
EOF
  exit 0
}

MODEL="opus"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --model) MODEL="$2"; shift 2 ;;
    -h|--help) usage ;;
    *) break ;;
  esac
done

PROMPT_FILE="${V0_DIR}/packages/cli/lib/prompts/mayor.md"
PROMPT="$(cat "${PROMPT_FILE}")"

# Create temporary settings for mayor session with auto-priming hooks
MAYOR_SETTINGS_DIR="${TMPDIR:-/tmp}/v0-mayor-$$"
mkdir -p "${MAYOR_SETTINGS_DIR}/.claude"

cat > "${MAYOR_SETTINGS_DIR}/.claude/settings.local.json" <<'SETTINGS'
{
  "permissions": {
    "allow": ["Bash(v0 *)", "Bash(wok *)", "Bash(bd *)", "Read", "Edit(*/plans/*)", "Write"]
  },
  "hooks": {
    "SessionStart": [
      {
        "matcher": "",
        "hooks": [
          {"type": "command", "command": "v0 prime"},
          {"type": "command", "command": "wk prime 2>/dev/null || true"},
          {"type": "command", "command": "v0 status 2>/dev/null || echo 'No v0 project in current directory'"},
          {"type": "command", "command": "wok ready 2>/dev/null || echo 'No ready issues'"}
        ]
      }
    ],
    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {"type": "command", "command": "v0 prime"},
          {"type": "command", "command": "wk prime 2>/dev/null || true"},
          {"type": "command", "command": "v0 status 2>/dev/null || echo 'No v0 project in current directory'"},
          {"type": "command", "command": "wok ready 2>/dev/null || echo 'No ready issues'"}
        ]
      }
    ]
  }
}
SETTINGS

# Initialize wok workspace link if v0 project has wok tracking
# This allows the mayor to create/manage bugs from the temp directory
if [[ -d "${V0_DIR}/.wok" ]]; then
  # Get prefix from wok config, default to "v0"
  WOK_PREFIX=$(grep '^prefix' "${V0_DIR}/.wok/config.toml" 2>/dev/null | sed 's/prefix *= *"\(.*\)"/\1/' || echo "v0")
  wok init --workspace "${V0_DIR}/.wok" --prefix "${WOK_PREFIX}" --path "${MAYOR_SETTINGS_DIR}" >/dev/null 2>&1 || true
fi

# Cleanup function for temporary settings
cleanup() {
  rm -rf "${MAYOR_SETTINGS_DIR}"
}
trap cleanup EXIT

# Run claude from the temp settings directory to ensure a fresh session each time.
# Claude identifies sessions by project directory, so using a unique temp dir (with PID)
# ensures SessionStart hooks fire on each invocation rather than resuming stale sessions.
cd "${MAYOR_SETTINGS_DIR}"
exec claude --model "${MODEL}" --settings ".claude/settings.local.json" "${PROMPT}" "$@"
