#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
# v0-archive - Move stale archived plans to icebox worktree
set -e

V0_DIR="$(cd "$(dirname "$0")/.." && pwd)"
source "${V0_DIR}/packages/cli/lib/v0-common.sh"
v0_load_config

usage() {
  v0_help <<'EOF'
v0 archive - Move stale archived plans to icebox worktree

Usage: v0 archive [options]

Options:
  -n, --dry-run    Show what would be archived without moving
  -d, --days N     Archive plans older than N days (default: 7)
  -a, --all        Archive all plans in archive/ (ignores age)
  -f, --force      Skip confirmation prompts
  -h, --help       Show this help message

The icebox is a separate 'v0/plans' branch managed via git worktree.
Archived plans are moved there and committed, keeping the main repo clean.

Examples:
  v0 archive                # Archive plans older than 7 days
  v0 archive --days 30      # Archive plans older than 30 days
  v0 archive --all          # Archive all plans
  v0 archive --dry-run      # Preview what would be archived
EOF
  exit 1
}

# Default configuration
DAYS=7
DRY_RUN=""
ALL=""
FORCE=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--dry-run) DRY_RUN=1; shift ;;
    -d|--days) DAYS="$2"; shift 2 ;;
    -a|--all) ALL=1; shift ;;
    -f|--force) FORCE=1; shift ;;
    -h|--help) usage ;;
    -*) echo "Unknown option: $1" >&2; usage ;;
    *) echo "Unexpected argument: $1" >&2; usage ;;
  esac
done

# ============================================================================
# Icebox Worktree Setup
# ============================================================================

# Setup icebox worktree
# Returns: icebox worktree path
setup_icebox_worktree() {
  local tree_output

  # Use v0-tree to create/find the worktree
  # Branch: v0/plans, tree name: v0-plans-icebox
  if ! tree_output=$("${V0_DIR}/bin/v0-tree" "v0-plans-icebox" --branch "v0/plans" 2>&1); then
    echo "Error: Failed to setup icebox worktree" >&2
    echo "${tree_output}" >&2
    return 1
  fi

  # v0-tree outputs two lines: TREE_DIR, then WORKTREE
  local icebox_worktree
  icebox_worktree=$(echo "${tree_output}" | tail -1)

  # Ensure plans directory exists in icebox
  mkdir -p "${icebox_worktree}/plans"

  echo "${icebox_worktree}"
}

# ============================================================================
# Plan Discovery and Age Filtering
# ============================================================================

# Calculate cutoff date (cross-platform)
get_cutoff_date() {
  local days="$1"
  # Try macOS first, fall back to GNU
  date -v-"${days}"d +%Y-%m-%d 2>/dev/null || \
  date -d "${days} days ago" +%Y-%m-%d 2>/dev/null
}

# Find archived plans older than N days
# Args: $1 = days threshold
# Output: List of plan paths (relative to PLANS_DIR)
find_stale_plans() {
  local days="$1"
  local cutoff_date
  cutoff_date=$(get_cutoff_date "${days}")

  local archive_dir="${PLANS_DIR}/archive"
  [[ -d "${archive_dir}" ]] || return 0

  # Find date directories older than cutoff
  for date_dir in "${archive_dir}"/*/; do
    [[ -d "${date_dir}" ]] || continue

    local dir_date
    dir_date=$(basename "${date_dir}")

    # Skip if not a valid date directory
    [[ "${dir_date}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]] || continue

    # Compare dates (lexicographic works for YYYY-MM-DD)
    if [[ "${dir_date}" < "${cutoff_date}" ]]; then
      # List plans in this directory
      for plan in "${date_dir}"*.md; do
        [[ -f "${plan}" ]] || continue
        # Output relative path from PLANS_DIR
        echo "${plan#"${PLANS_DIR}"/}"
      done
    fi
  done
}

# Find all archived plans (for --all flag)
find_all_archived_plans() {
  local archive_dir="${PLANS_DIR}/archive"
  [[ -d "${archive_dir}" ]] || return 0

  find "${archive_dir}" -name "*.md" -type f 2>/dev/null | while read -r plan; do
    echo "${plan#"${PLANS_DIR}"/}"
  done
}

# ============================================================================
# Plan Migration to Icebox
# ============================================================================

# Remove empty date directories from archive
cleanup_empty_archive_dirs() {
  local archive_dir="${PLANS_DIR}/archive"
  [[ -d "${archive_dir}" ]] || return 0

  find "${archive_dir}" -type d -empty -delete 2>/dev/null || true
}

# Move plans to icebox worktree
# Args: $1 = icebox worktree path, $@ = list of plan relative paths
archive_to_icebox() {
  local icebox="$1"
  shift
  local plans=("$@")

  if [[ ${#plans[@]} -eq 0 ]]; then
    echo "No plans to archive"
    return 0
  fi

  local archived=0

  for plan_rel in "${plans[@]}"; do
    if [[ -n "${DRY_RUN}" ]]; then
      echo "Would archive: ${plan_rel}"
    else
      local src="${PLANS_DIR}/${plan_rel}"
      local dest="${icebox}/plans/${plan_rel}"

      # Create destination directory structure
      mkdir -p "$(dirname "${dest}")"
      mv "${src}" "${dest}"
      echo "Archived: ${plan_rel}"
      archived=$((archived + 1))
    fi
  done

  if [[ -z "${DRY_RUN}" ]] && [[ ${archived} -gt 0 ]]; then
    # Commit in icebox worktree
    (
      cd "${icebox}"
      git add -A plans/
      git commit --no-verify -m "Archive ${archived} plan(s) to icebox" \
        -m "Moved from main repo archive/ by v0 archive"
    ) || echo "Warning: Failed to commit in icebox worktree"

    # Clean up empty directories in main repo
    cleanup_empty_archive_dirs

    # Commit removal in main repo
    (
      cd "${V0_ROOT}"
      git add -A "${V0_PLANS_DIR}/archive/"
      git commit --no-verify -m "Move ${archived} archived plan(s) to icebox" \
        -m "Plans moved to v0/plans branch by v0 archive"
    ) || echo "Warning: Failed to commit archive cleanup"
  fi

  if [[ -z "${DRY_RUN}" ]]; then
    echo ""
    echo "Archived ${archived} plan(s) to icebox"
    echo "Icebox branch: v0/plans"
    echo "Icebox worktree: ${icebox}"
  fi
}

# ============================================================================
# Main
# ============================================================================

main() {
  local plans=()
  local plan

  # Find plans to archive (bash 3.2 compatible - no mapfile)
  if [[ -n "${ALL}" ]]; then
    while IFS= read -r plan; do
      [[ -n "${plan}" ]] && plans+=("${plan}")
    done < <(find_all_archived_plans)
  else
    while IFS= read -r plan; do
      [[ -n "${plan}" ]] && plans+=("${plan}")
    done < <(find_stale_plans "${DAYS}")
  fi

  if [[ ${#plans[@]} -eq 0 ]]; then
    if [[ -n "${ALL}" ]]; then
      echo "No archived plans found in archive/"
    else
      echo "No archived plans older than ${DAYS} days"
    fi
    exit 0
  fi

  # Confirm unless --force or --dry-run
  if [[ -z "${FORCE}" ]] && [[ -z "${DRY_RUN}" ]]; then
    echo "Found ${#plans[@]} plan(s) to archive:"
    printf '  %s\n' "${plans[@]}"
    echo ""
    printf "Move to icebox? [y/N] "
    read -r confirm
    if [[ "${confirm}" != "y" ]] && [[ "${confirm}" != "Y" ]]; then
      echo "Aborted"
      exit 1
    fi
  fi

  # Setup icebox worktree (skip for dry-run to avoid side effects)
  local icebox=""
  if [[ -z "${DRY_RUN}" ]]; then
    if ! icebox=$(setup_icebox_worktree); then
      exit 1
    fi
  fi

  # Archive plans
  archive_to_icebox "${icebox}" "${plans[@]}"
}

main
