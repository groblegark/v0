#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Get current year
YEAR=$(date +%Y)
COPYRIGHT="Copyright (c) $YEAR Alfred Jean LLC"

# License header for bash scripts
BASH_HEADER="# SPDX-License-Identifier: MIT
# $COPYRIGHT"

# Add or replace license header in a bash file (after shebang)
add_bash_header() {
    local file="$1"

    # Check if file already has correct header
    if grep -q "SPDX-License-Identifier: MIT" "$file" && \
       grep -q "$COPYRIGHT" "$file"; then
        return 0
    fi

    # Preserve original permissions
    local perms
    perms=$(stat -f "%OLp" "$file")

    # Extract shebang if present
    local shebang=""
    local start_line=1
    if head -1 "$file" | grep -q "^#!"; then
        shebang=$(head -1 "$file")
        start_line=2
    fi

    # Get content, skipping old header lines
    local content
    content=$(tail -n +$start_line "$file" | sed '/^# SPDX-License-Identifier/d; /^# Copyright/d' | sed '1{/^$/d;}')

    # Reconstruct file
    {
        if [[ -n "$shebang" ]]; then
            echo "$shebang"
        fi
        echo "$BASH_HEADER"
        echo "$content"
    } > "$file.tmp"
    mv "$file.tmp" "$file"

    # Restore original permissions
    chmod "$perms" "$file"
    echo "Updated header: $file"
}

# Update copyright year in LICENSE file
update_license_file() {
    local file="$ROOT_DIR/LICENSE"
    if [[ -f "$file" ]]; then
        if grep -q "$COPYRIGHT" "$file"; then
            return 0
        fi
        sed -i '' "s/Copyright (c) [0-9]* Alfred Jean LLC/$COPYRIGHT/" "$file"
        echo "Updated: LICENSE"
    fi
}

# Update copyright year in README.md
update_readme() {
    local file="$ROOT_DIR/README.md"
    if [[ -f "$file" ]]; then
        if grep -q "MIT - $COPYRIGHT" "$file"; then
            return 0
        fi
        sed -i '' "s/MIT - Copyright (c) [0-9]* Alfred Jean LLC/MIT - $COPYRIGHT/" "$file"
        echo "Updated: README.md"
    fi
}

cd "$ROOT_DIR"

echo "Using copyright year: $YEAR"
echo ""

# Update LICENSE and README
update_license_file
update_readme

# Process bin/ scripts
echo "Processing bin/ scripts..."
for file in bin/v0*; do
    if [ -f "$file" ] && head -1 "$file" | grep -qE "^#!.*(bash|sh)"; then
        add_bash_header "$file"
    fi
done

# Process lib/ scripts
echo "Processing lib/ scripts..."
for file in lib/*.sh; do
    if [ -f "$file" ]; then
        add_bash_header "$file"
    fi
done

# Process hooks/ scripts
echo "Processing hooks/ scripts..."
for file in hooks/*.sh; do
    if [ -f "$file" ]; then
        add_bash_header "$file"
    fi
done

# Process install scripts
echo "Processing install scripts..."
if [ -f "install.sh" ]; then
    add_bash_header "install.sh"
fi

echo "Done."
