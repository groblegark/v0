#!/bin/bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# License header for bash scripts
BASH_HEADER="# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC"

# Add license header to a bash file (after shebang)
add_bash_header() {
    local file="$1"

    # Skip if already has SPDX header
    if grep -q "SPDX-License-Identifier" "$file"; then
        return 0
    fi

    # Preserve original permissions
    local perms
    perms=$(stat -f "%OLp" "$file")

    # Check if file starts with shebang
    if head -1 "$file" | grep -q "^#!"; then
        # Extract shebang and rest of file
        local shebang
        shebang=$(head -1 "$file")
        local rest
        rest=$(tail -n +2 "$file")

        # Reconstruct file with shebang, header, then rest
        {
            echo "$shebang"
            echo "$BASH_HEADER"
            echo "$rest"
        } > "$file.tmp"
        mv "$file.tmp" "$file"
    else
        # No shebang - add header at top
        {
            echo "$BASH_HEADER"
            echo ""
            cat "$file"
        } > "$file.tmp"
        mv "$file.tmp" "$file"
    fi

    # Restore original permissions
    chmod "$perms" "$file"
    echo "Added header to: $file"
}

cd "$ROOT_DIR"

# Process bin/ scripts
echo "Processing bin/ scripts..."
for file in bin/v0*; do
    if [ -f "$file" ] && head -1 "$file" | grep -qE "^#!.*(bash|sh)"; then
        add_bash_header "$file"
    fi
done

# Process lib/ scripts
echo "Processing lib/ scripts..."
for file in lib/*.sh; do
    if [ -f "$file" ]; then
        add_bash_header "$file"
    fi
done

# Process hooks/ scripts
echo "Processing hooks/ scripts..."
for file in hooks/*.sh; do
    if [ -f "$file" ]; then
        add_bash_header "$file"
    fi
done

# Process install scripts
echo "Processing install scripts..."
for file in install.sh install-remote.sh; do
    if [ -f "$file" ]; then
        add_bash_header "$file"
    fi
done

echo "Done."
