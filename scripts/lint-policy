#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Alfred Jean LLC
#
# Policy enforcement for CI lints.
#
# Checks:
# 1. No new disables added to .shellcheckrc (vs base branch)
# 2. No shellcheck disable comments in scripts (inline exceptions)
#
# Usage: ./lint-policy [--base-branch main]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Default base branch for comparison
BASE_BRANCH="${1:-main}"
if [[ "$BASE_BRANCH" == "--base-branch" ]]; then
    BASE_BRANCH="${2:-main}"
fi

ERRORS=0

# =============================================================================
# Check 1: .shellcheckrc policy
# =============================================================================
check_shellcheckrc() {
    local shellcheckrc="$ROOT_DIR/.shellcheckrc"
    [[ ! -f "$shellcheckrc" ]] && return
    git -C "$ROOT_DIR" rev-parse --git-dir >/dev/null 2>&1 || return
    git -C "$ROOT_DIR" rev-parse "$BASE_BRANCH" >/dev/null 2>&1 || return

    local base_shellcheckrc
    base_shellcheckrc=$(git -C "$ROOT_DIR" show "$BASE_BRANCH:.shellcheckrc" 2>/dev/null || echo "")
    [[ -z "$base_shellcheckrc" ]] && return

    local current_disables base_disables new_disables
    current_disables=$(grep '^disable=' "$shellcheckrc" 2>/dev/null | sed 's/^disable=//' | tr ',' '\n' | sort || true)
    base_disables=$(echo "$base_shellcheckrc" | grep '^disable=' 2>/dev/null | sed 's/^disable=//' | tr ',' '\n' | sort || true)
    new_disables=$(comm -23 <(echo "$current_disables") <(echo "$base_disables") 2>/dev/null || true)

    if [[ -n "$new_disables" ]]; then
        echo "ERROR: New shellcheck disables in .shellcheckrc:"
        echo "$new_disables" | sed 's/^/  /'
        ERRORS=$((ERRORS + 1))
    fi
}

# =============================================================================
# Check 2: Inline shellcheck exceptions policy
# =============================================================================

# Inline disables allowed because they're case-specific with documentation.
ALLOWED_INLINE_DISABLES=(
    "SC2012"  # ls usage - sometimes needed for sorting by time
    "SC2090"  # eval usage - intentional in specific cases
)

check_inline_shellcheck() {
    local exclude_pattern
    exclude_pattern=$(printf '%s|' "${ALLOWED_INLINE_DISABLES[@]}")
    exclude_pattern="${exclude_pattern%|}"

    local violations=""

    if [[ -d "$ROOT_DIR/scripts" ]]; then
        local script_violations
        script_violations=$(grep -rn "# shellcheck disable=" "$ROOT_DIR/scripts" --exclude="lint-policy" 2>/dev/null | grep -v -E "${exclude_pattern}" || true)
        violations="$violations$script_violations"
    fi

    if [[ -d "$ROOT_DIR/bin" ]]; then
        local bin_violations
        bin_violations=$(grep -rn "# shellcheck disable=" "$ROOT_DIR/bin" 2>/dev/null | grep -v -E "${exclude_pattern}" || true)
        [[ -n "$bin_violations" ]] && violations="$violations
$bin_violations"
    fi

    if [[ -d "$ROOT_DIR/lib" ]]; then
        local lib_violations
        lib_violations=$(grep -rn "# shellcheck disable=" "$ROOT_DIR/lib" 2>/dev/null | grep -v -E "${exclude_pattern}" || true)
        [[ -n "$lib_violations" ]] && violations="$violations
$lib_violations"
    fi

    violations=$(echo "$violations" | grep -v '^$' || true)

    if [[ -n "$violations" ]]; then
        echo "ERROR: Inline shellcheck disable comments:"
        echo "$violations" | sed 's/^/  /'
        echo "Allowed: ${ALLOWED_INLINE_DISABLES[*]}"
        ERRORS=$((ERRORS + 1))
    fi
}

# =============================================================================
# Main
# =============================================================================
check_shellcheckrc
check_inline_shellcheck

if [[ $ERRORS -gt 0 ]]; then
    echo ""
    echo "=== FAILED: $ERRORS policy violation(s) ==="
    exit 1
fi
