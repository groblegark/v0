# Profile: Separate V0_DEVELOP_BRANCH into .v0.profile.rc

## Overview

Separate user-specific configuration (particularly `V0_DEVELOP_BRANCH`) from the shared `.v0.rc` into a new `.v0.profile.rc` file. This allows `.v0.rc` to be committed while keeping user-specific branch names (like `v0/agent/kestred-d96b`) out of version control.

The `.v0.profile.rc` file is only generated when no `--develop` flag is provided to `v0 init` (i.e., when auto-generating a user branch).

## Project Structure

Files to modify:
```
packages/core/lib/config.sh     # Main implementation (v0_init_config, v0_load_config)
docs/arch/SYSTEM.md             # Environment variables documentation
docs/arch/commands/v0.md        # v0 init command documentation
README.md                       # User-facing documentation
```

New files generated by `v0 init`:
```
.v0.profile.rc                  # User-specific settings (gitignored)
```

## Dependencies

None - this is a shell script change using existing utilities.

## Implementation Phases

### Phase 1: Modify `v0_init_config()` to Generate Profile File

**File:** `packages/core/lib/config.sh` (function `v0_init_config`, lines ~325-487)

1. Add `.v0.profile.rc` to `.gitignore` during init (similar to existing `.v0/` logic)
2. When `develop_branch` is auto-generated (no `--develop` flag provided):
   - Create `.v0.profile.rc` with `V0_DEVELOP_BRANCH` export
   - In `.v0.rc`, replace the `V0_DEVELOP_BRANCH=...` line with a comment and source directive

**Changes to `v0_init_config()`:**

After the gitignore logic for `.v0/` (~line 379), add `.v0.profile.rc` to gitignore:
```bash
# Add .v0.profile.rc to gitignore (user-specific, not committed)
if [[ -f "${target_dir}/.gitignore" ]]; then
  if ! v0_grep_quiet "^\.v0\.profile\.rc$" "${target_dir}/.gitignore"; then
    echo ".v0.profile.rc" >> "${target_dir}/.gitignore"
    echo "Added .v0.profile.rc to .gitignore"
  fi
else
  echo ".v0.profile.rc" > "${target_dir}/.gitignore"
  echo "Created .gitignore with .v0.profile.rc"
fi
```

Track whether branch was auto-generated:
```bash
# Track if branch was auto-generated (no --develop provided)
local branch_auto_generated=false
if [[ -z "${develop_branch}" ]]; then
  develop_branch=$(v0_generate_user_branch)
  branch_auto_generated=true
fi
```

Generate `.v0.profile.rc` when branch is auto-generated:
```bash
# Create .v0.profile.rc for user-specific settings (only if auto-generated)
local profile_file="${target_dir}/.v0.profile.rc"
if [[ "${branch_auto_generated}" == "true" ]] && [[ ! -f "${profile_file}" ]]; then
  cat > "${profile_file}" <<EOF
# v0 user profile (not committed - user-specific settings)
# This file is sourced by .v0.rc

export V0_DEVELOP_BRANCH="${develop_branch}"
EOF
  echo "Created ${profile_file} (gitignored)"
fi
```

Modify the `.v0.rc` template generation to conditionally include profile sourcing:
```bash
# In the heredoc for .v0.rc, change the branch_line logic:
if [[ "${branch_auto_generated}" == "true" ]]; then
  branch_line="# V0_DEVELOP_BRANCH defined in .v0.profile.rc (user-specific)
[[ -f \"\${V0_ROOT:-\$(dirname \"\${BASH_SOURCE[0]}\")/.v0.profile.rc\" ]] && source \"\${V0_ROOT:-\$(dirname \"\${BASH_SOURCE[0]}\")/.v0.profile.rc\""
else
  branch_line="V0_DEVELOP_BRANCH=\"${develop_branch}\"     # Target branch for merges"
fi
```

**Verification:**
- Run `v0 init` in a test directory with no flags → should create `.v0.profile.rc` and modified `.v0.rc`
- Run `v0 init --develop v0/develop` → should NOT create `.v0.profile.rc`, `V0_DEVELOP_BRANCH` in `.v0.rc` directly

### Phase 2: Update `v0_load_config()` for Profile Loading

**File:** `packages/core/lib/config.sh` (function `v0_load_config`, lines ~107-188)

The current `.v0.rc` template change handles sourcing, but we need to ensure backwards compatibility and proper loading order.

**Changes:**

After sourcing `.v0.rc` (~line 141), add explicit profile loading as a fallback:
```bash
# Load project config (overrides defaults)
source "${V0_ROOT}/.v0.rc"

# Source profile if exists and V0_DEVELOP_BRANCH still at default
# (handles case where .v0.rc doesn't have the source line yet)
if [[ "${V0_DEVELOP_BRANCH}" == "main" ]] && [[ -f "${V0_ROOT}/.v0.profile.rc" ]]; then
  source "${V0_ROOT}/.v0.profile.rc"
fi
```

**Verification:**
- Existing `.v0.rc` files without profile sourcing should still work
- New `.v0.rc` files with profile sourcing should work
- `v0 status`, `v0 build`, etc. should load config correctly

### Phase 3: Update Documentation

**File:** `docs/arch/SYSTEM.md`

Add `.v0.profile.rc` to Key Files table (~line 66):
```markdown
| `.v0.profile.rc` | User-specific config (gitignored) |
```

Update Environment Variables section (~line 158) to note sourcing:
```markdown
| `V0_DEVELOP_BRANCH` | Target branch for merges | `v0/agent/{username}-{id}` (in `.v0.profile.rc` if auto-generated) |
```

**File:** `docs/arch/commands/v0.md`

Add note about profile file:
```markdown
## Init Defaults

| Setting | Default | Description |
|---------|---------|-------------|
| `V0_DEVELOP_BRANCH` | `v0/agent/{username}-{id}` | Unique per-user branch (stored in `.v0.profile.rc`) |
| `V0_GIT_REMOTE` | `agent` | Local bare repo at `~/.local/state/v0/${PROJECT}/remotes/agent.git` |

When no `--develop` flag is provided, `v0 init` creates a `.v0.profile.rc` file with the auto-generated branch name. This file is gitignored so each developer gets their own branch.
```

**File:** `README.md`

Update the Configuration section (~line 168):
```markdown
## Configuration

Running `v0 init` creates:
- `.v0.rc` - Project configuration (commit this)
- `.v0.profile.rc` - User-specific settings like your unique branch (gitignored)

If you provide `--develop`, only `.v0.rc` is created with the branch inline.
```

**Verification:**
- Documentation accurately reflects new behavior
- Examples are correct

### Phase 4: Test Existing Functionality

Verify no regressions:
- `v0 init` creates both files correctly
- `v0 init --develop main` only creates `.v0.rc` (no profile)
- `v0 status` works with new config structure
- `v0 build` works with new config structure
- Existing projects without `.v0.profile.rc` continue to work

**Test commands:**
```bash
# Test new init behavior
cd /tmp && mkdir test-profile && cd test-profile
git init
v0 init
cat .v0.rc           # Should have source line, no V0_DEVELOP_BRANCH
cat .v0.profile.rc   # Should have V0_DEVELOP_BRANCH
cat .gitignore       # Should include .v0.profile.rc

# Test explicit branch behavior
cd /tmp && mkdir test-explicit && cd test-explicit
git init
v0 init --develop v0/develop
cat .v0.rc           # Should have V0_DEVELOP_BRANCH inline
ls .v0.profile.rc    # Should not exist

# Run full test suite
make check
```

## Key Implementation Details

### Source Path Resolution

The `.v0.rc` file needs to source `.v0.profile.rc` using a path that works regardless of where the script is sourced from. Using `${BASH_SOURCE[0]}` to get the directory:

```bash
[[ -f "${V0_ROOT:-$(dirname "${BASH_SOURCE[0]}")/.v0.profile.rc" ]] && \
  source "${V0_ROOT:-$(dirname "${BASH_SOURCE[0]}")/.v0.profile.rc"
```

This handles:
- Normal loading via `v0_load_config()` where `V0_ROOT` is set
- Direct sourcing of `.v0.rc` where we need to derive the path

### Backwards Compatibility

The changes are backwards compatible:
- Existing `.v0.rc` files with inline `V0_DEVELOP_BRANCH` continue to work
- The fallback in `v0_load_config()` handles migration cases
- No existing behavior changes unless `v0 init` is re-run

### Idempotency

`v0 init` is already idempotent for `.v0.rc`. We maintain this:
- Only create `.v0.profile.rc` if it doesn't exist AND branch is auto-generated
- Existing profile files are preserved

## Verification Plan

1. **Unit tests** - Verify `v0_load_config()` sources profile correctly
2. **Manual testing** - Test `v0 init` with and without `--develop` flag
3. **Integration** - Run `make check` to verify no regressions
4. **Migration** - Test that existing projects work without changes
